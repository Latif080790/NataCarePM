rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is project member
    function isProjectMember(projectId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid));
    }
    
    // Check if user has specific role in project
    function hasProjectRole(projectId, role) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/projects/$(projectId)/members/$(request.auth.uid)).data.role == role;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Validate required fields exist
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }
    
    // ============================================
    // DEFAULT: DENY ALL
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Users can only read their own profile or admins can read all
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can only update their own profile
      allow update: if isOwner(userId) && 
                      hasRequiredFields(['name', 'email', 'updatedAt']);
      
      // Admin can create/delete users
      allow create, delete: if isAdmin();
      
      // User preferences subcollection
      match /preferences/{prefId} {
        allow read, write: if isOwner(userId);
      }
      
      // User notifications
      match /notifications/{notificationId} {
        allow read: if isOwner(userId);
        allow update: if isOwner(userId); // Mark as read
        allow create: if isAuthenticated(); // System can create
      }
    }
    
    // ============================================
    // PROJECTS COLLECTION
    // ============================================
    match /projects/{projectId} {
      // Project members can read
      allow read: if isProjectMember(projectId);
      
      // Only project admins can update/delete
      allow update, delete: if hasProjectRole(projectId, 'admin');
      
      // System/admin can create projects
      allow create: if isAdmin() && 
                      hasRequiredFields(['name', 'location', 'startDate', 'createdAt']);
      
      // ============================================
      // PROJECT SUBCOLLECTIONS
      // ============================================
      
      // Project Members
      match /members/{memberId} {
        allow read: if isProjectMember(projectId);
        allow write: if hasProjectRole(projectId, 'admin');
      }
      
      // Daily Reports
      match /dailyReports/{reportId} {
        allow read: if isProjectMember(projectId);
        allow create: if isProjectMember(projectId) && 
                        hasRequiredFields(['date', 'weather', 'createdBy', 'createdAt']);
        allow update: if isProjectMember(projectId);
        allow delete: if hasProjectRole(projectId, 'admin');
      }
      
      // RAB/Budget Items
      match /items/{itemId} {
        allow read: if isProjectMember(projectId);
        allow write: if hasProjectRole(projectId, 'admin') || 
                       hasProjectRole(projectId, 'finance');
      }
      
      // Expenses
      match /expenses/{expenseId} {
        allow read: if isProjectMember(projectId);
        allow create: if isProjectMember(projectId) && 
                        hasRequiredFields(['amount', 'category', 'date', 'createdAt']);
        allow update, delete: if hasProjectRole(projectId, 'admin') || 
                                hasProjectRole(projectId, 'finance');
      }
      
      // Purchase Orders
      match /purchaseOrders/{poId} {
        allow read: if isProjectMember(projectId);
        allow create: if isProjectMember(projectId) && 
                        hasRequiredFields(['prNumber', 'vendor', 'items', 'createdAt']);
        allow update: if isProjectMember(projectId);
        allow delete: if hasProjectRole(projectId, 'admin');
      }
      
      // Inventory
      match /inventory/{inventoryId} {
        allow read: if isProjectMember(projectId);
        allow write: if hasProjectRole(projectId, 'admin') || 
                       hasProjectRole(projectId, 'logistics') ||
                       hasProjectRole(projectId, 'procurement');
      }
      
      // Documents
      match /documents/{documentId} {
        allow read: if isProjectMember(projectId);
        allow create: if isProjectMember(projectId) && 
                        hasRequiredFields(['name', 'type', 'uploadedBy', 'uploadedAt']);
        allow update: if isProjectMember(projectId) || 
                        request.resource.data.uploadedBy == request.auth.uid;
        allow delete: if hasProjectRole(projectId, 'admin') || 
                        resource.data.uploadedBy == request.auth.uid;
      }
      
      // Tasks
      match /tasks/{taskId} {
        allow read: if isProjectMember(projectId);
        allow create: if isProjectMember(projectId) && 
                        hasRequiredFields(['title', 'status', 'createdBy', 'createdAt']);
        allow update: if isProjectMember(projectId);
        allow delete: if hasProjectRole(projectId, 'admin');
      }
      
      // Attendances
      match /attendances/{attendanceId} {
        allow read: if isProjectMember(projectId);
        allow write: if hasProjectRole(projectId, 'admin') || 
                       hasProjectRole(projectId, 'supervisor') ||
                       hasProjectRole(projectId, 'hr');
      }
      
      // Termins (Payment Terms)
      match /termins/{terminId} {
        allow read: if isProjectMember(projectId);
        allow write: if hasProjectRole(projectId, 'admin') || 
                       hasProjectRole(projectId, 'finance');
      }
      
      // Audit Logs (read-only for non-admins)
      match /auditLog/{logId} {
        allow read: if isProjectMember(projectId);
        allow create: if isAuthenticated(); // System creates
        allow update, delete: if false; // Immutable
      }
      
      // Safety Incidents
      match /safetyIncidents/{incidentId} {
        allow read: if isProjectMember(projectId);
        allow create: if isProjectMember(projectId) && 
                        hasRequiredFields(['incidentNumber', 'type', 'severity', 'createdAt']);
        allow update: if isProjectMember(projectId);
        allow delete: if hasProjectRole(projectId, 'admin');
      }
      
      // PPE Inventory
      match /ppeInventory/{ppeId} {
        allow read: if isProjectMember(projectId);
        allow write: if hasProjectRole(projectId, 'admin') || 
                       hasProjectRole(projectId, 'safety') ||
                       hasProjectRole(projectId, 'logistics');
      }
      
      // Training Records
      match /training/{trainingId} {
        allow read: if isProjectMember(projectId);
        allow write: if isProjectMember(projectId);
      }
      
      // Material Requests
      match /materialRequests/{mrId} {
        allow read: if isProjectMember(projectId);
        allow create: if isProjectMember(projectId) && 
                        hasRequiredFields(['mrNumber', 'requestedBy', 'createdAt']);
        allow update: if isProjectMember(projectId);
        allow delete: if hasProjectRole(projectId, 'admin');
      }
      
      // Goods Receipts
      match /goodsReceipts/{grId} {
        allow read: if isProjectMember(projectId);
        allow create: if isProjectMember(projectId) && 
                        hasRequiredFields(['grNumber', 'receivedBy', 'createdAt']);
        allow update: if isProjectMember(projectId);
        allow delete: if hasProjectRole(projectId, 'admin');
      }
      
      // Vendors
      match /vendors/{vendorId} {
        allow read: if isProjectMember(projectId);
        allow write: if hasProjectRole(projectId, 'admin') || 
                       hasProjectRole(projectId, 'procurement');
      }
      
      // Financial Transactions
      match /transactions/{transactionId} {
        allow read: if isProjectMember(projectId);
        allow create: if (hasProjectRole(projectId, 'admin') || 
                         hasProjectRole(projectId, 'finance')) && 
                        hasRequiredFields(['type', 'amount', 'date', 'createdAt']);
        allow update, delete: if hasProjectRole(projectId, 'admin');
      }
      
      // Journal Entries
      match /journalEntries/{entryId} {
        allow read: if isProjectMember(projectId);
        allow write: if hasProjectRole(projectId, 'admin') || 
                       hasProjectRole(projectId, 'finance');
      }
      
      // Chart of Accounts
      match /chartOfAccounts/{accountId} {
        allow read: if isProjectMember(projectId);
        allow write: if hasProjectRole(projectId, 'admin') || 
                       hasProjectRole(projectId, 'finance');
      }
    }
    
    // ============================================
    // WORKSPACES COLLECTION
    // ============================================
    match /workspaces/{workspaceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION (Global)
    // ============================================
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                    resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated(); // System creates
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid; // Mark as read
      allow delete: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // SYSTEM CONFIGURATION (Admin only)
    // ============================================
    match /config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // AHSP DATA (Reference data - read-only for most)
    // ============================================
    match /ahspData/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // WORKERS/EMPLOYEES
    // ============================================
    match /workers/{workerId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // ACTIVITY LOGS (System-wide)
    // ============================================
    match /activityLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated(); // System creates
      allow update, delete: if false; // Immutable
    }
  }
}
