rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().roleId == role;
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().roleId in roles;
    }
    
    // ============================================
    // FILE SIZE LIMITS
    // ============================================
    
    function isValidSize() {
      return request.resource.size <= 10 * 1024 * 1024; // 10MB
    }
    
    function isValidImageSize() {
      return request.resource.size <= 5 * 1024 * 1024; // 5MB for images
    }
    
    // ============================================
    // FILE TYPE VALIDATION
    // ============================================
    
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    function isPDF() {
      return request.resource.contentType == 'application/pdf';
    }
    
    function isDocument() {
      return request.resource.contentType.matches('application/(pdf|msword|vnd.openxmlformats-officedocument.*)') ||
             request.resource.contentType.matches('text/(plain|csv)');
    }
    
    function isAllowedType() {
      return isImage() || isPDF() || isDocument();
    }
    
    // ============================================
    // USER AVATARS
    // ============================================
    
    match /avatars/{userId}/{fileName} {
      // Users can read any avatar
      allow read: if isAuthenticated();
      
      // Users can only upload their own avatar
      allow create, update: if isAuthenticated() && 
                               request.auth.uid == userId &&
                               isImage() &&
                               isValidImageSize();
      
      // Users can delete their own avatar
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // PROJECT DOCUMENTS
    // ============================================
    
    match /projects/{projectId}/documents/{fileName} {
      // Project members can read documents
      allow read: if isAuthenticated();
      
      // Only authorized roles can upload documents
      allow create: if hasAnyRole(['admin', 'pm', 'site_manager']) &&
                       isAllowedType() &&
                       isValidSize();
      
      // Only authorized roles can update documents
      allow update: if hasAnyRole(['admin', 'pm', 'site_manager']) &&
                       isAllowedType() &&
                       isValidSize();
      
      // Only admins and PMs can delete documents
      allow delete: if hasAnyRole(['admin', 'pm']);
    }
    
    // ============================================
    // DAILY REPORTS ATTACHMENTS
    // ============================================
    
    match /projects/{projectId}/reports/{reportId}/{fileName} {
      allow read: if isAuthenticated();
      
      allow create, update: if hasAnyRole(['admin', 'pm', 'site_manager']) &&
                               isAllowedType() &&
                               isValidSize();
      
      allow delete: if hasAnyRole(['admin', 'pm']);
    }
    
    // ============================================
    // PURCHASE ORDER ATTACHMENTS
    // ============================================
    
    match /projects/{projectId}/purchaseOrders/{poId}/{fileName} {
      allow read: if isAuthenticated();
      
      allow create, update: if hasAnyRole(['admin', 'pm', 'finance']) &&
                               isAllowedType() &&
                               isValidSize();
      
      allow delete: if hasAnyRole(['admin', 'pm', 'finance']);
    }
    
    // ============================================
    // EXPENSE RECEIPTS
    // ============================================
    
    match /projects/{projectId}/expenses/{expenseId}/{fileName} {
      allow read: if isAuthenticated();
      
      allow create, update: if hasAnyRole(['admin', 'pm', 'finance']) &&
                               (isImage() || isPDF()) &&
                               isValidSize();
      
      allow delete: if hasAnyRole(['admin', 'pm', 'finance']);
    }
    
    // ============================================
    // TASK ATTACHMENTS
    // ============================================
    
    match /tasks/{taskId}/attachments/{fileName} {
      allow read: if isAuthenticated();
      
      allow create, update: if isAuthenticated() &&
                               isAllowedType() &&
                               isValidSize();
      
      allow delete: if hasAnyRole(['admin', 'pm']);
    }
    
    // ============================================
    // EXPORTED REPORTS
    // ============================================
    
    match /exports/{userId}/{fileName} {
      // Users can only read their own exports
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // System can create exports
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Auto-delete after 7 days (managed by Cloud Functions)
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // COMPANY ASSETS (logos, branding)
    // ============================================
    
    match /company/{fileName} {
      allow read: if true; // Public read for branding
      allow write: if hasRole('admin') && isImage() && isValidImageSize();
    }
    
    // Block all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
