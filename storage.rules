rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if file size is within limit (in MB)
    function isValidSize(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }
    
    // Check if file type is allowed
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    function isPDF() {
      return request.resource.contentType == 'application/pdf';
    }
    
    function isDocument() {
      return request.resource.contentType.matches('application/.*') ||
             request.resource.contentType.matches('text/.*');
    }
    
    function isAllowedDocumentType() {
      return request.resource.contentType in [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-powerpoint',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'text/plain',
        'text/csv',
        'image/jpeg',
        'image/png',
        'image/gif',
        'image/webp',
        'image/svg+xml'
      ];
    }
    
    // Check if user is project member (would need Firestore lookup)
    function isProjectMember(projectId) {
      return isAuthenticated() && 
             firestore.exists(/databases/(default)/documents/projects/$(projectId)/members/$(request.auth.uid));
    }
    
    // ============================================
    // DEFAULT: DENY ALL
    // ============================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
    
    // ============================================
    // USER PROFILE PHOTOS
    // ============================================
    match /users/{userId}/profile/{fileName} {
      // Users can read any profile photo
      allow read: if isAuthenticated();
      
      // Users can only upload/update their own profile photo
      allow write: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     isImage() &&
                     isValidSize(5); // Max 5MB
    }
    
    // ============================================
    // PROJECT DOCUMENTS
    // ============================================
    match /projects/{projectId}/documents/{documentId}/{fileName} {
      // Project members can read documents
      allow read: if isProjectMember(projectId);
      
      // Project members can upload documents with restrictions
      allow create: if isProjectMember(projectId) &&
                      isAllowedDocumentType() &&
                      isValidSize(50); // Max 50MB per document
      
      // Only document uploader or admins can update
      allow update: if isProjectMember(projectId);
      
      // Only document uploader or admins can delete
      allow delete: if isProjectMember(projectId);
    }
    
    // ============================================
    // DAILY REPORT PHOTOS
    // ============================================
    match /projects/{projectId}/dailyReports/{reportId}/photos/{photoId} {
      // Project members can read photos
      allow read: if isProjectMember(projectId);
      
      // Project members can upload photos
      allow create: if isProjectMember(projectId) &&
                      isImage() &&
                      isValidSize(10); // Max 10MB per photo
      
      // Project members can update/delete photos
      allow update, delete: if isProjectMember(projectId);
    }
    
    // ============================================
    // INCIDENT PHOTOS (Safety)
    // ============================================
    match /projects/{projectId}/incidents/{incidentId}/photos/{photoId} {
      // Project members can read incident photos
      allow read: if isProjectMember(projectId);
      
      // Project members can upload incident photos
      allow create: if isProjectMember(projectId) &&
                      isImage() &&
                      isValidSize(10); // Max 10MB per photo
      
      // Only incident reporter or admins can update/delete
      allow update, delete: if isProjectMember(projectId);
    }
    
    // ============================================
    // INCIDENT DOCUMENTS (Safety)
    // ============================================
    match /projects/{projectId}/incidents/{incidentId}/documents/{documentId} {
      // Project members can read incident documents
      allow read: if isProjectMember(projectId);
      
      // Project members can upload incident documents
      allow create: if isProjectMember(projectId) &&
                      isAllowedDocumentType() &&
                      isValidSize(20); // Max 20MB
      
      // Only incident reporter or admins can update/delete
      allow update, delete: if isProjectMember(projectId);
    }
    
    // ============================================
    // TRAINING MATERIALS
    // ============================================
    match /projects/{projectId}/training/{trainingId}/materials/{materialId} {
      // Project members can read training materials
      allow read: if isProjectMember(projectId);
      
      // Only trainers/admins can upload materials
      allow create: if isProjectMember(projectId) &&
                      isAllowedDocumentType() &&
                      isValidSize(100); // Max 100MB for training videos/materials
      
      // Only uploader or admins can update/delete
      allow update, delete: if isProjectMember(projectId);
    }
    
    // ============================================
    // PURCHASE ORDER ATTACHMENTS
    // ============================================
    match /projects/{projectId}/purchaseOrders/{poId}/attachments/{attachmentId} {
      // Project members can read PO attachments
      allow read: if isProjectMember(projectId);
      
      // Project members can upload attachments
      allow create: if isProjectMember(projectId) &&
                      isAllowedDocumentType() &&
                      isValidSize(20); // Max 20MB
      
      // Project members can update/delete attachments
      allow update, delete: if isProjectMember(projectId);
    }
    
    // ============================================
    // GOODS RECEIPT PHOTOS
    // ============================================
    match /projects/{projectId}/goodsReceipts/{grId}/photos/{photoId} {
      // Project members can read GR photos
      allow read: if isProjectMember(projectId);
      
      // Project members can upload photos
      allow create: if isProjectMember(projectId) &&
                      isImage() &&
                      isValidSize(10); // Max 10MB per photo
      
      // Project members can update/delete photos
      allow update, delete: if isProjectMember(projectId);
    }
    
    // ============================================
    // OCR PROCESSED DOCUMENTS
    // ============================================
    match /projects/{projectId}/ocr/{documentId}/{fileName} {
      // Project members can read OCR documents
      allow read: if isProjectMember(projectId);
      
      // Project members can upload for OCR processing
      allow create: if isProjectMember(projectId) &&
                      (isImage() || isPDF()) &&
                      isValidSize(30); // Max 30MB
      
      // System can update (OCR results)
      allow update: if isProjectMember(projectId);
      
      // Only uploader can delete
      allow delete: if isProjectMember(projectId);
    }
    
    // ============================================
    // DIGITAL SIGNATURES
    // ============================================
    match /projects/{projectId}/signatures/{documentId}/{signatureId} {
      // Project members can read signatures
      allow read: if isProjectMember(projectId);
      
      // Only authenticated users can create signatures
      allow create: if isProjectMember(projectId) &&
                      isImage() &&
                      isValidSize(1); // Max 1MB for signature
      
      // Signatures are immutable once created
      allow update, delete: if false;
    }
    
    // ============================================
    // FINANCIAL DOCUMENTS
    // ============================================
    match /projects/{projectId}/financial/{category}/{documentId} {
      // Only project members with finance role can access
      allow read: if isProjectMember(projectId);
      
      // Only finance team can upload
      allow create: if isProjectMember(projectId) &&
                      isAllowedDocumentType() &&
                      isValidSize(50); // Max 50MB
      
      // Only finance team can update/delete
      allow update, delete: if isProjectMember(projectId);
    }
    
    // ============================================
    // BACKUP FILES (System)
    // ============================================
    match /backups/{backupId}/{fileName} {
      // Only system/admin can access backups
      allow read, write: if false; // System only via service account
    }
    
    // ============================================
    // TEMPORARY UPLOADS
    // ============================================
    match /temp/{userId}/{fileName} {
      // Users can upload to temp for processing
      allow create: if isAuthenticated() &&
                      request.auth.uid == userId &&
                      isAllowedDocumentType() &&
                      isValidSize(100); // Max 100MB
      
      // Users can read/delete their own temp files
      allow read, delete: if isAuthenticated() && 
                            request.auth.uid == userId;
      
      // Temp files auto-delete after 24 hours (configured in lifecycle rules)
    }
  }
}
